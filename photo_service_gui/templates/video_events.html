{% extends "open_base_new.html" %}

{% block titleheader %}
  Video events
{% endblock %}

{% block headercontainer %}Deteksjon målpassering <img id=header_icon src="../static/icon_photos.png"> {% endblock %}

{% block titlemain %}
  <img id=menu_icon src="../static/icon_photos.png"> Deteksjon målpassering
{% endblock %}
{% block menuitems %}{% endblock %}

<! --- Information --->
{% block tips %}
  <table>
    <tr>
      <td colspan="2">
        Dette er kontrollpanel for video service. Siden inneholder både mulighet til å konfigurere tjenesten samt overvåke. Video tjenesten analyserer en videostrøm og identifiserer personer som krysser en (mål)linje.
  Det lages to bilder av passeringen, ett av bare selve personen (crop) og ett av hele skjermen.
      </td>
    </tr>
    <tr>
      <td valign="top">
        <b>Camera shots</b> - her vises mål-linje og siste deteksjon.
        <br><b>Configuration</b> - Mulighet for å stille inn video url og linje-koordinater.
        <br><b>Avansert</b> - Mulighet for å nullstille, dette krever normalt påfølgende restart av VIDEO SERVICE og INTEGRATION SERVICE.
        <br><b>Simulering</b> - (For testing) Her er det mulig å få systemet til å generere passeringer. Krever at url til resultatserver (eksempel http://ragdesprinten.norwayeast.azure.com:8080) gis som input.
      </td>
      <td>
        Storage mode - <b>local_storage</b>: local file system used for storage. Integration service for pushing detections.
          <b>cloud_storage</b> - capture run locally and integration service pushing captured files directly to cloud bucket, detection stored directly on cloud storage.
        <br>INTEGRATION SERVICE: (Pubsub) vil sende informasjon til Google Cloud. Bildene sendes til en Storage Bucket,
        mens informasjon sendes til Pubsub og legges på en meldingskø der interessenter kan abonnere på hendelsene.
        <br>VIDEO SERVICE: Tjenesten har 2 workers: CAPTURE og DETECT som jobber med videoen.
        <b>Status</b> - Her vises statusmeldinger for tjenesten. Både det som registreres på videoen og at meldingenr sendes til meldingskøen (Google pubsub).
      </td>
    </tr>
  </table>
{% endblock %}
<! --- End Information --->

{% block content %}
<script>
  /* this function will sync (update+get) status updates with backend */
  let syncRunning = false;
  function sync_status() {
    if (syncRunning) return; // Exit if already running
    syncRunning = true;

    try {
      var formData = "video_status=true&event_id={{ event_id }}"
      formData = formData + "&photo_queue=true"
      
      loadDoc("POST", "/video_events", mySync, formData);

      function mySync(xhttp) {
        try {
          // load new info
          const jsonDoc = JSON.parse(xhttp.response);
          document.getElementById("send_result").innerHTML = jsonDoc.video_status;
          document.getElementById("local_captured_queue_length").innerHTML = jsonDoc.local_captured_queue_length;
          document.getElementById("cloud_captured_queue_length").innerHTML = jsonDoc.cloud_captured_queue_length;
          const photo_latest = jsonDoc.photo_latest;
          if (photo_latest != "") {
            document.getElementById("photo_latest").src = photo_latest;
          }
          else {
            document.getElementById("photo_latest").src = "../static/no_image.png";
          }
          const trigger_line_url = jsonDoc.trigger_line_url;
          if (trigger_line_url != "") {
            document.getElementById("trigger_line_photo").src = trigger_line_url;
          }
          else {
            document.getElementById("trigger_line_photo").src = "../static/no_image.png";
          }

          // Update service status indicators - capture video service
          if (jsonDoc.service_status.capture_video_start) {
              document.getElementById("capture_video_service_status").innerHTML = "Video: Kjører";
              document.getElementById("capture_video_service_status").className = "label label-success";
              document.getElementById("capture_video_service").innerHTML = "Stop";
              document.getElementById("capture_video_service").value = "Stop";
          } else if (jsonDoc.service_status.capture_video_available) {
              document.getElementById("capture_video_service_status").innerHTML = "Video: Pauset";
              document.getElementById("capture_video_service_status").className = "label label-warning";
              document.getElementById("capture_video_service").innerHTML = "Start";
              document.getElementById("capture_video_service").value = "Start";
          }
          else {
              document.getElementById("capture_video_service_status").innerHTML = "Video: Ikke tilgjengelig";
              document.getElementById("capture_video_service_status").className = "label label-danger";
              document.getElementById("capture_video_service").innerHTML = "-";
              document.getElementById("capture_video_service").value = "-";
          }

          // Update service status indicators - integration service
          if (jsonDoc.service_status.integration_start) {
              document.getElementById("integration_service_status").innerHTML = "Opplasting: Kjører";
              document.getElementById("integration_service_status").className = "label label-success";
          } else if (jsonDoc.service_status.integration_available) {
              document.getElementById("integration_service_status").innerHTML = "Opplasting: Pauset";
              document.getElementById("integration_service_status").className = "label label-warning";
          }
          else {
              document.getElementById("integration_service_status").innerHTML = "Opplasting: Ikke tilgjengelig";
              document.getElementById("integration_service_status").className = "label label-danger";
          }

          // Update service status indicators - detect video service
          if (jsonDoc.service_status.detect_video_start) {
              document.getElementById("detect_video_service_status").innerHTML = "Deteksjon: Kjører";
              document.getElementById("detect_video_service_status").className = "label label-success";
              document.getElementById("detect_video_service").innerHTML = "Stop";
              document.getElementById("detect_video_service").value = "Stop";
          } else if (jsonDoc.service_status.detect_video_available) {
              document.getElementById("detect_video_service_status").innerHTML = "Deteksjon: Pauset";
              document.getElementById("detect_video_service_status").className = "label label-warning";
              document.getElementById("detect_video_service").innerHTML = "Start";
              document.getElementById("detect_video_service").value = "Start";
          }
          else {
              document.getElementById("detect_video_service_status").innerHTML = "Deteksjon: Ikke tilgjengelig";
              document.getElementById("detect_video_service_status").className = "label label-danger";
              document.getElementById("detect_video_service").innerHTML = "-";
              document.getElementById("detect_video_service").value = "-";
          }

        }
        catch(err) {
            alert(err);
        }
      }
    }
    catch(err) {
        alert(err);
    } finally {
      syncRunning = false; // Ensure flag is cleared even on errors
      setTimeout(sync_status, 4000);
    }
  }

  /* this function will get status updates */
  function loadDoc(req, url, cFunction, formData) {
    const xhttp = new XMLHttpRequest();
    xhttp.onload = function() {cFunction(this);}
    xhttp.open(req, url, true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.send(formData);
  }

  /* this function will show actual simulation_url */
  function update_simulation_url() {
              var sim_url = document.getElementById("sim_list").value;
              var sim_round = document.getElementById("sim_round").value;
              var actual_url = sim_url + "/csv?event_id={{ event_id }}&action=startlist&round=" + sim_round;
              document.getElementById("actual_url").innerHTML = actual_url;
              document.getElementById("sim_actual_url").value = actual_url;
            }

</script>

    <section class="row" aria-label="Service status">
      <div class="col-sm-4">
        <div class="status-card" role="status" aria-live="polite">
          <h4>Målkamera</h4>
          <p>
            <span id="capture_video_service_status" class="label label-danger">-</span>
            <span id="integration_service_status" class="label label-danger">-</span>
          </p>
          <small>Kø: <strong id="local_captured_queue_length">0</strong></small>
          <form action=/video_events method=post>
            <button type="submit" id="capture_video_service" name="capture_video_service" value="-" class="btn btn-default">-</button>
            <input type="hidden" name=event_id value="{{ event_id }}">
          </form>
        </div>
        <!-- preview inside the card -->
        <figure class="preview-figure">
          <img id="trigger_line_photo" class="preview-img" src="../static/no_image.png"
              alt="Crossing line, click to view big size" title="Click to enlarge">
        </figure>

      </div>

      <div class="col-sm-4">
        <div class="status-card" role="status" aria-live="polite">
          <h4>Passeringer</h4>
          <p>
            <span id="detect_video_service_status" class="label label-danger">-</span>
          </p>
          <small>Kø: <strong id="cloud_captured_queue_length">0</strong></small>
          <form action=/video_events method=post>
            <button type="submit" id="detect_video_service" name="detect_video_service" value="-" class="btn btn-default">-</button>
            <input type="hidden" name=event_id value="{{ event_id }}">
          </form>
        </div>
        <!-- preview inside the card -->
        <img id="photo_latest" class="preview-img" src="../static/no_image.png"
            alt="Latest detection">


      </div>

      <div class="col-sm-4">
        <div class="status-card">
          <h4>Siste hendelser (logg)</h4>
          <p id="send_result">—</p> 
        </div>
      </div>
    </section>
  <div id="spacer"></div>
  <details class="content-box">
    <summary>Konfigurasjon (klikk for å utvide)</summary>

    <section class="row" aria-label="Previews and configuration">
      <div class="col-md-6 preview-col">
          <form action="/video_events" method="post" class="form-vertical" id="config-form" aria-label="Video configuration">
            <fieldset>
              <legend>Video innstillinger</legend>

              <div class="form-group">
                <label for="trigger_line_xyxyn">Mållinjen</label> (x1:y1:x2:y2 , eks: 0.0:0.75:1.0:0.75)
                <input id="trigger_line_xyxyn" name="trigger_line_xyxyn" type="text" class="form-control" value="{{ trigger_line_xyxyn }}">
              </div>

              <div class="form-group">
                <label for="video_url">Video URL</label>
                <input id="video_url" name="video_url" type="url" class="form-control" value="{{ video_url }}">
              </div>

              <div class="form-group">
                <label for="video_clip_duration">Videoklipp varighet (s)</label>
                <input id="video_clip_duration" name="video_clip_duration" type="number" class="form-control" value="{{ service_status.video_clip_duration }}">
              </div>

              <div class="form-group">
                <label for="video_clip_fps">FPS</label> (antall bilder per sekund)
                <input id="video_clip_fps" name="video_clip_fps" type="number" class="form-control" value="{{ service_status.video_clip_fps }}">
              </div>

              <div class="form-group">
                <label for="confidence_limit">Confidence limit</label> (minimum confidence for detections)
                <input id="confidence_limit" name="confidence_limit" type="number" class="form-control" value="{{ service_status.confidence_limit }}">
              </div>

              <div class="form-group">
                <label for="detect_image_size">Image resolution</label>
                <select name="detect_image_size" class="form-control">
                  <option value={{ service_status.detect_analytics_im_size }}>{{ service_status.detect_analytics_im_size }}</option>
                  {% for one_res in service_status.video_analytics_im_size_def %}
                    <option value={{ one_res }}>{{ one_res }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group">
                <label for="storage_mode">Video storage mode</label>
                <select id="storage_mode" name="storage_mode" class="form-control">
                  <option value="0">{{ service_status.storage_mode_name }}</option>
                  <option value="cloud_storage">Cloud storage</option>
                  <option value="local_storage">Local storage</option>
                </select>
              </div>

              <div style="margin-top:8px;">
                <button type="submit" name="update_config" class="btn btn-success">Lagre</button>
                <button type="submit" name="reset_config" class="btn btn-warning">Nullstill</button>
              </div>
            </fieldset>
          </form>
      </div>
      <div class="col-md-6 preview-col">
          <form action="/video_events" method="post" class="form-vertical" id="config-form" aria-label="Video configuration">
            <fieldset>
              <legend>Simulering av passeringer</legend>

              <div class="form-group">
                <label for="sim_list">Startlister</label> (url til server som leverer startlister)
                <input id="sim_list" name="sim_list" type="text" class="form-control" value="http://localhost:8080" onchange=update_simulation_url()>
                Runde: <select name="sim_round" id="sim_round" onchange=update_simulation_url()>
                  <option value="Q">Q</option>
                  <option value="S">S</option>
                  <option value="F">F</option>
                </select>
                <small><span id="actual_url"></span></small>
                <input type="hidden" name=sim_actual_url id=sim_actual_url value="">
                <script>update_simulation_url()</script>
              </div>

              <div class="form-group">
                <label for="sim_fastest_time">Raskeste tid</label> (antatt løpstid i sekunder)
                <input id="sim_fastest_time" name="sim_fastest_time" type="number" class="form-control" value="{{ sim_fastest_time }}">
              </div>

              <div style="margin-top:8px;">
                <button type="submit" name="update_config" class="btn btn-default">Start</button>
              </div>

            </fieldset>
          </form>
      </div>
  </details>

  <script>
      // Initial call to start the cycle
      setTimeout(sync_status, 4000);

      // Get the modal
      document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('photo-modal');
        const modalImg = document.getElementById('modal-img');
        const trigger = document.getElementById('trigger_line_photo');
        const closeBtn = document.querySelector('.close-modal');

        trigger.onclick = function() {
          modal.style.display = "block";
          modalImg.src = this.src;
        }

        closeBtn.onclick = function() {
          modal.style.display = "none";
        }

        // Close when clicking outside image
        modal.onclick = function(e) {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        }

        // Close on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modal.style.display === 'block') {
            modal.style.display = "none";
          }
        });
      });
  </script>
  <div id="photo-modal" class="modal" aria-hidden="true" role="dialog">
    <div class="modal-content">
      <span class="close-modal" title="Lukk">&times;</span>
      <img id="modal-img" src="" alt="">
    </div>
  </div>
{% endblock %}
