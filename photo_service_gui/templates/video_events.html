{% extends "open_base.html" %}
{% block titlecontainer %}
<div class="w3-10"></div>
<div class="w3-80">
{% endblock %}

{% block titleheader %}
  Video events
{% endblock %}

{% block headercontainer %}Video events <img id=header_icon src="../static/icon_photos.png"> {% endblock %}

{% block titlemain %}
  <img id=menu_icon src="../static/icon_photos.png"> Video events
{% endblock %}

{% block menuitems %}{% endblock %}

{% block content %}
  <script>
    /* fuction to start video analyse */
    function video_ai_run(button) {
      try {
        document.getElementById(button.id).innerHTML = " Starter... ";
        document.getElementById(button.id).disabled = true;
        var old_info = document.getElementById("analyse_result").innerHTML;
        var video_url = document.getElementById("video_ai_url").value;

        // get current time, hours, minutes
        var d = new Date();
        var current_time = d.toLocaleTimeString();
        document.getElementById("analyse_result").innerHTML = current_time + " - Starter analyse, url: " + video_url + "<br>" + old_info;
        old_info = document.getElementById("analyse_result").innerHTML;

        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/video_ai?action=run", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        var formData = "";
        formData += "action=run&video_ai_url=" + video_url;

        xhttp.send(formData);
        xhttp.onload = function() {
          try {
            // load new info
            const info = this.response;
            document.getElementById("analyse_result").innerHTML = current_time + " - " + info + "<br>" + old_info;
            document.getElementById(button.id).innerHTML = " Start video-analyse ";
            document.getElementById(button.id).disabled = false;
          }
          catch(err) {
            if (err.message.indexOf("401") > 0) {
              alert("Error 401 - Logg inn på nytt.");
            }
            else {
              document.getElementById("analyse_result").innerHTML = err;
              alert(err);
            }
            document.getElementById(button.id).innerHTML = " Start video-analyse ";
            document.getElementById(button.id).disabled = false;
          }
        }
      }
      catch(err) {
          alert(err);
          document.getElementById(button.id).innerHTML = " Start video-analyse ";
          document.getElementById(button.id).disabled = false;
        }
        return false; // avoid to execute the actual submit of the form.
      }


    function get_events(button) {
      document.getElementById(button.id).innerHTML = " Mottar... ";
      document.getElementById(button.id).disabled = true;
      return true;
    }
    /* this function will send events to queue without reloading the page */
    function pub_events_new(button) {
      try {
        document.getElementById(button.id).innerHTML = " Sender... ";
        document.getElementById(button.id).disabled = true;
        var old_info = document.getElementById("send_reslut").innerHTML;
        // get current time, hours, minutes
        var d = new Date();
        var current_time = d.toLocaleTimeString();

        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/pub_events?action=pub", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        var formData = "";
        formData += "action=pub&event_id={{ event_id }}"

        xhttp.send(formData);
        xhttp.onload = function() {
          try {
            // load new info
            const info = this.response;
            document.getElementById("send_reslut").innerHTML = current_time + " - " + info + "<br>" + old_info;
            document.getElementById(button.id).innerHTML = " Send ny ";
            document.getElementById(button.id).disabled = false;
          }
          catch(err) {
            if (err.message.indexOf("401") > 0) {
              alert("Error 401 - Logg inn på nytt.");
            }
            else {
              document.getElementById("send_reslut").innerHTML = err;
              alert(err);
            }
            document.getElementById(button.id).innerHTML = " Send ny ";
            document.getElementById(button.id).disabled = false;
          }
        }
      }
      catch(err) {
          alert(err);
          document.getElementById(button.id).innerHTML = " Send ny ";
          document.getElementById(button.id).disabled = false;
        }
        return false; // avoid to execute the actual submit of the form.
      }
  </script>

  <table>
    <form action=/video_events method=post">
      <tr>
        <td align=center>
          <input type="hidden" name=event_id value="{{ event_id }}">
          <input type="submit" name="pull_message" onsubmit=get_events(this); value="  Hent fra kø (test) ">

        </td>
      </form>
        <td align=center>
          <button type="button" id="pub_events_button" onclick="pub_events_new(this);" > Send nye bilder fra video-analyse </button>
        </td>
        <td align=center>
          <!-- add input text with url to video -->
          <input type="text" id="video_ai_url" name="video_ai_url" value="http://" size="20">
          <br>
          <button type="button" id="video_ai_button" onclick="video_ai_run(this);" > Start video-analyse </button>
        </td>
    </tr>
    <tr>
      <td id="orange">
        <span id="hent_result"></span>
      </td>
      <td id="orange">
        <span id="send_reslut"></span>
      </td>
      <td id="orange">
        <span id="analyse_result"></span>
      </td>
  </tr>
</table>
{% endblock %}
</div>
