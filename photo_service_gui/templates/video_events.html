{% extends "open_base.html" %}
{% block titlecontainer %}
<div class="w3-80">
{% endblock %}

{% block titleheader %}
  Video events
{% endblock %}

{% block headercontainer %}Video events <img id=header_icon src="../static/icon_photos.png"> {% endblock %}

{% block titlemain %}
  <img id=menu_icon src="../static/icon_photos.png"> Video events
{% endblock %}

{% block menuitems %}{% endblock %}

{% block content %}
  <script>

    /* this function will get status updates */
    function get_status_updates() {
      try {
        loadDoc("POST", "/video_events", myFunctionGSU, "video_status=true&event_id={{ event_id }}");

        function myFunctionGSU(xhttp) {
          try {
            // load new info
            const info = xhttp.response;
            document.getElementById("send_result").innerHTML = info;
          }
          catch(err) {
              alert(err);
          }
        }
      }
      catch(err) {
          alert(err);
      }
      return false; // avoid to execute the actual submit of the form.
    }

    /* this function will get status updates */
    function loadDoc(req, url, cFunction, formData) {
      const xhttp = new XMLHttpRequest();
      xhttp.onload = function() {cFunction(this);}
      xhttp.open(req, url, true);
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.send(formData);
    }


      
    /* this function will stop video analytics */
    function video_analytics_stop() {
      try {
        loadDoc("POST", "/video_events", myFunctionVAStop, "video_analytics_stop=true&event_id={{ event_id }}");

        function myFunctionVAStop(xhttp) {
          try {
            // load new info
            const info = xhttp.response;
            old_info = document.getElementById("send_result").innerHTML
            document.getElementById("send_result").innerHTML = info + "<br>" + old_info;
          }
          catch(err) {
              alert(err);
          }
        }
      }
      catch(err) {
          alert(err);
        }
        return false; // avoid to execute the actual submit of the form.
      }

    /* this function will trigger video analytics */
    function detect_crossings_new() {
      try {
        loadDoc("POST", "/video_events", myFunctionVAStart, "video_analytics_start=true&event_id={{ event_id }}");

        function myFunctionVAStart(xhttp) {
          try {
            // load new info
            const info = xhttp.response;
            old_info = document.getElementById("send_result").innerHTML
            document.getElementById("send_result").innerHTML = info + "<br>" + old_info;
          }
          catch(err) {
              alert(err);
          }
        }
      }
      catch(err) {
          alert(err);
        }
        return false; // avoid to execute the actual submit of the form.
      }

    /* this function will trigger automatic updates */
    function pub_events_reload() {
      try {
        var checkBox = document.getElementById("pub_events_automatic");
        if (checkBox.checked) {
          pub_events_new();
        }
      }
      catch(err) {
          alert(err);
      }
    }
    function video_analytics_checked(checkBox) {
      try {
        if (checkBox.checked) {
          detect_crossings_new();
        }
        else {
          video_analytics_stop();
        }
      }
      catch(err) {
          alert(err);
        }
    }

    /* this function will send events to queue */
    function pub_events_new() {
      try {
        loadDoc("POST", "/video_events", myFunctionPEN, "pub_message=true&event_id={{ event_id }}");

        function myFunctionPEN(xhttp) {
          try {
            // load new info
            const info = xhttp.response;
            old_info = document.getElementById("send_result").innerHTML
            document.getElementById("send_result").innerHTML = info + "<br>" + old_info;
          }
          catch(err) {
              alert(err);
          }
        }
      }
      catch(err) {
          alert(err);
        }
        return false; // avoid to execute the actual submit of the form.
      }
  </script>

  <table>
    <tr id="headerblack">
      <td>Status messages</td>
      <td>Service status</td>
      <td>Line crossing configuration</td>
    </tr>
    <tr height="500">
      <td id="orange" valign="top">
        <span id="send_result"></span>
      </td>
      <td valign="top">
        <table> 
          <tr>  
            <td>Photos ready for sending</td>
            <td><span id="photo_queue_length">{{ photo_queue|length }}</span></td>
          </tr>
          <tr>  
            <td>Video analytics</td>
            <td><input type="checkbox" id="video_analytics_automatic" name="video_analytics_checkbox" value="video_analytics_checkbox" {% if video_analytics_running == "true" %} checked {% endif %}> Start</td>
          </tr>
          <tr>  
            <td>Pubsub - send photos</td>
            <td><input type="checkbox" id="pub_events_automatic" name="pub_events_checkbox" value="pub_events_checkbox"> Start</td>
          </tr>
        </table>
        <span id="photo_queue">
          {% for photo in photo_queue %}
            <img width=100 src="{{ photo }}" title="{{ photo }}">
            {% if loop.index % 3 == 0 %}<br>{% endif %}
          {% endfor %}
        </span>
      </td>
      <td valign="top">
        <form action=/video_events method=post>
          <input type="hidden" name="event_id" value="{{ event_id }}">
          <table> 
            <tr>
              <td>Trigger line config</td>
              <td><input type="text" id="trigger_line_xyxyn" name="trigger_line_xyxyn" value="{{ trigger_line_xyxyn }}"> (eks: 0.1:0.8:0.9:0.8)</td>
            </tr>
            <tr>
              <td>Video url</td>
              <td><input type="text" id="video_url" name="video_url" value="{{ video_url }}" size="50"></td>
            </tr>
            <tr>
              <td></td>
              <td><input type="submit" name="update_config" value="  Lagre  "></td>
            </tr>
          </table>
        </form>
        <br><img width=600 src="{{ line_config_file }}">
      </td>
    </tr>
</table>
<script>
  // trigger every 15 seconds
  window.setInterval(pub_events_reload, 10000);
  window.setInterval(get_status_updates, 10000);

  const video_checkbox = document.getElementById("video_analytics_automatic");
  video_checkbox.addEventListener("change", () => {
    // Do something when the checkbox is checked.
    video_analytics_checked(video_checkbox)
  });

</script>
{% endblock %}
</div>