{% extends "open_base_new.html" %}

{% block titleheader %}
  Deteksjon målpassering - {{ event.name }}
{% endblock %}

{% block headercontainer %}Deteksjon målpassering <img id=header_icon src="../static/icon_photos.png"> {% endblock %}

{% block titlemain %}
  <img id=menu_icon src="../static/icon_photos.png"> Deteksjon målpassering
{% endblock %}
{% block menuitems %}
  <li class=dropdown>
    <a class=dropbtn><b>Kl: {{ local_time_now }}</b></a>
  </li>
{% endblock %}

<! --- Information --->
{% block tips %}
  Dette er kontrollpanel for video service. Siden inneholder både mulighet til å konfigurere tjenesten samt overvåke. Video tjenesten analyserer en videostrøm og identifiserer personer som krysser en (mål)linje.
  Det lages to bilder av passeringen, ett av bare selve personen (crop) og ett av hele skjermen.
  <ul>
    <li><b>Målkamera</b>: Her vises status på tjenesten som lagrer video av målpassering. I tillegg kan man se bilde av registrert mål-linje. I køen vises antall råfiler og antall video filer ferdig prosessert.</li>
    <li><b>Passeringer</b>: Her vises status på tjenesten som detekterer passeringer. I tillegg kan man se bilde av sist registrerte passering. I køen vises antall filer som venter på deteksjon.</li>
    <li><b>Siste hendelser</b>: Her vises informasjon om de siste hendelsene som er registrert av systemet.</li>
    <li><b>Avansert</b>: Mulighet for å nullstille, dette krever normalt påfølgende restart av VIDEO SERVICE og INTEGRATION SERVICE.</li>
  </ul>
  <br>
  <b>Konfigurasjon</b>
  <br>
  Her kan alle parametere for video tjenesten settes. Dette inkluderer definisjon av mållinje, video url, videoklipp varighet, fps, confidence limit, bildeoppløsning for analyse og lagringsmodus.
  <ul>
    <li><b>local_storage</b>: local file system used for storage. Detections are pushed directly to cloud storage by the video service.</li>
    <li><b>cloud_storage</b>: capture run locally and integration service pushing captured files directly to cloud bucket, detection stored directly on cloud storage.</li>
  </ul>
{% endblock %}
<! --- End Information --->

{% block content %}
<script>
  /* Calculate time elapsed since timestamp in HH:MM:SS format */
  function getTimeAgo(timestamp) {
    if (!timestamp) return '-';
    
    const now = new Date();
    const then = new Date(timestamp);
    const diffMs = now - then;
    
    if (diffMs < 0) return '0:00:00';
    
    const hours = Math.floor(diffMs / (1000 * 60 * 60));
    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
    
    const mm = String(minutes).padStart(2, '0');
    const ss = String(seconds).padStart(2, '0');
    
    if (hours > 0) {
      return `${hours} hours`;
    } else if (minutes > 0) {
      return `${minutes} min`;
    } else {
      return `${ss} sek`;
    }
  }

    function action_toggle(action, instance_id, event_id, new_value) {
      var xhttp = new XMLHttpRequest();
      xhttp.open("POST", "/video_events", true);
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.send("instance_action=" + action + "&instance_id=" + instance_id + "&event_id=" + event_id + "&new_value=" + new_value);
      xhttp.onload = function() {

        // load new info
        const jsonDoc = JSON.parse(this.response);

        document.getElementById("info").innerHTML = jsonDoc;
      }
    }



  /* Format service instances for display */
  function formatServiceInstances(instances, service_type) {
    if (!instances || instances.length === 0) {
      return '<p>Ingen aktive tjenester</p>';
    }
    
    let html = '';
    instances.forEach(instance => {
      if (!instance.service_type.includes(service_type)) {
        return;
      }
      
      const statusClass = instance.status === 'running' ? 'label-success' : 
                          instance.status === 'stopped' ? 'label-default' : 'label-warning';
      let actionButton = '';
      if (instance.service_type != 'VIDEO_SERVICE_CAPTURE_SRT') {
        actionText = instance.status === 'running' ? 'stop' : 'start';
        actionButton = `<button type="submit" onclick="action_toggle('${actionText}', '${instance.id}', '{{ event_id }}', '')" class="btn btn-default">${actionText}</button>`;
      }
      const icon_url = instance.service_type === 'VIDEO_SERVICE_CAPTURE_SRT' ? '<img id=menu_icon src=../static/capture.png title=Video> Cloud streaming' : 
                       instance.service_type === 'VIDEO_SERVICE_CAPTURE_LOCAL' ? '<img id=menu_icon src=../static/capture.png title=Video> Video to local' : 
                       instance.service_type === 'VIDEO_SERVICE_DETECT' ? '<img id=menu_icon src=../static/upload.png title=Video> Detect' : '<img id=menu_icon src=../static/upload.png title=Video> Upload';
      
      html += `
          <div class="status-card" role="status" aria-live="polite">
            <table>
              <tr>
                <td>${icon_url}</td>
                <td align="right"><span class="label ${statusClass}">${instance.status}</span></td>
              </tr>
              <tr>
                <td>Instance:<strong> ${instance.instance_name}</strong></td>
                <td></td>
              </tr>
              <tr>
                <td>Last seen:<strong> ${getTimeAgo(instance.last_heartbeat)} ago</strong></td>
                <td align="right" rowspan="2">
                    ${actionButton}
                </td>
              </tr>
              <tr>
                <td>Trigger line: ${instance.metadata.trigger_line_xyxyn}</td>
              </tr>
            </table>
      `;
      html += '</div><br>';
    });
    
    return html;
  }

  /* this function will sync (update+get) status updates with backend */
  let syncRunning = false;
  function sync_status() {
    if (syncRunning) return; // Exit if already running
    syncRunning = true;

    try {
      var formData = "video_status=true&event_id={{ event_id }}"
      formData = formData + "&photo_queue=true"
      
      loadDoc("POST", "/video_events", mySync, formData);

      function mySync(xhttp) {
        try {
          // load new info
          const jsonDoc = JSON.parse(xhttp.response);
          document.getElementById("send_result").innerHTML = jsonDoc.video_status;
          document.getElementById("capture_service_instances").innerHTML = formatServiceInstances(jsonDoc.service_instances, 'CAPTURE');
          document.getElementById("detect_service_instances").innerHTML = formatServiceInstances(jsonDoc.service_instances, 'DETECT');
          document.getElementById("local_raw_captured_queue_length").innerHTML = jsonDoc.local_raw_captured_queue_length;
          document.getElementById("local_captured_queue_length").innerHTML = jsonDoc.local_captured_queue_length;
          document.getElementById("cloud_captured_queue_length").innerHTML = jsonDoc.cloud_captured_queue_length;
          const photo_latest = jsonDoc.photo_latest;
          if (photo_latest != "") {
            document.getElementById("photo_latest").src = photo_latest;
          }
          else {
            document.getElementById("photo_latest").src = "../static/no_image.png";
          }
          const trigger_line_url = jsonDoc.trigger_line_url;
          if (trigger_line_url != "") {
            document.getElementById("trigger_line_photo").src = trigger_line_url;
          }
          else {
            document.getElementById("trigger_line_photo").src = "../static/no_image.png";
          }

        }
        catch(err) {
            alert(err);
        }
      }
    }
    catch(err) {
        alert(err);
    } finally {
      syncRunning = false; // Ensure flag is cleared even on errors
      setTimeout(sync_status, 10000);
    }
  }

  /* this function will get status updates */
  function loadDoc(req, url, cFunction, formData) {
    const xhttp = new XMLHttpRequest();
    xhttp.onload = function() {cFunction(this);}
    xhttp.open(req, url, true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.send(formData);
  }

</script>
    <section class="row" aria-label="Service status">
      <div class="col-sm-4">
        <table>
          <tr>
            <td><h4>Målkamera</h4></td>
            <td>
              (<strong id="local_raw_captured_queue_length">0</strong> råfiler
              {% if service_status.storage_mode_name == "cloud_storage" %} og <strong id="local_captured_queue_length">0</strong> videoer{% endif %} i kø)
            </td>
          </tr>
        </table>
        <span id="capture_service_instances"></span>
        <!-- preview inside the card -->
        <figure class="preview-figure">
          <img id="trigger_line_photo" class="preview-img" src="../static/no_image.png"
              alt="Crossing line, click to view big size" title="Click to enlarge">
        </figure>
      </div>
      <div class="col-sm-4">
        <table>
          <tr>
            <td><h4>Passeringer</h4></td>
            <td>(
              {% if service_status.storage_mode_name == "cloud_storage" %}
                <strong id="cloud_captured_queue_length">0</strong>
              {% else %}
                <strong id="local_captured_queue_length">0</strong>
                <input type="hidden" id="cloud_captured_queue_length" value="0">
              {% endif %} videoer i kø)
            </td>
          </tr>
        </table>
        <span id="detect_service_instances"></span>
        <!-- preview inside the card -->
        <figure class="preview-figure">
          <img id="photo_latest" class="preview-img" src="../static/no_image.png"
              alt="Latest detection">
        </figure>
      </div>

      <div class="col-sm-4">
        <div class="status-card" role="status" aria-live="polite">
            <button type="submit" onclick="action_toggle('start_all', '', '{{ event_id }}', '')" class="btn btn-default">Start all services</button>
            <button type="submit" onclick="action_toggle('stop_all', '', '{{ event_id }}', '')" class="btn btn-default">Stop all services</button>
        </div>
        <h4>Siste hendelser (logg)</h4>
        <div class="status-card" role="status" aria-live="polite">
          <p id="send_result">—</p> 
        </div>
      </div>
    </section>
  <div id="spacer"></div>
  <hr>
  <details class="content-box">
    <summary>Konfigurasjon (klikk for å utvide)</summary>
    <fieldset>
      <legend>Video innstillinger</legend>

      <section class="row" aria-label="Previews and configuration">
        <div class="col-md-6 preview-col">
          <form action="/video_events" method="post" class="form-vertical" id="config-form" aria-label="Video configuration">
            <div class="form-group">
              <label for="trigger_line_xyxyn">Mållinjen</label> (x1:y1:x2:y2 , eks: 0.0:0.75:1.0:0.75)
              <input id="trigger_line_xyxyn" name="trigger_line_xyxyn" type="text" class="form-control" value="{{ trigger_line_xyxyn }}">
            </div>

            <div class="form-group">
              <label for="video_url">Video URL</label>
              <input id="video_url" name="video_url" class="form-control" value="{{ video_url }}">
            </div>

            <div class="form-group">
              <label for="video_clip_duration">Videoklipp varighet (s)</label>
              <input id="video_clip_duration" name="video_clip_duration" type="number" class="form-control" value="{{ service_status.video_clip_duration }}">
            </div>

            <div class="form-group">
              <label for="video_clip_fps">FPS</label> (antall bilder per sekund)
              <input id="video_clip_fps" name="video_clip_fps" type="number" class="form-control" value="{{ service_status.video_clip_fps }}">
            </div>
        </div>
        <div class="col-md-6 preview-col">
            <div class="form-group">
              <label for="confidence_limit">Confidence limit</label> (minimum confidence for detections)
              <input id="confidence_limit" name="confidence_limit" type="number" class="form-control" value="{{ service_status.confidence_limit }}">
            </div>

            <div class="form-group">
              <label for="detect_image_size">Image resolution</label>
              <select name="detect_image_size" class="form-control">
                <option value={{ service_status.detect_analytics_im_size }}>{{ service_status.detect_analytics_im_size }}</option>
                {% for one_res in service_status.video_analytics_im_size_def %}
                  <option value={{ one_res }}>{{ one_res }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label for="storage_mode">Video storage mode</label>
              <select id="storage_mode" name="storage_mode" class="form-control">
                <option value="0">{{ service_status.storage_mode_name }}</option>
                <option value="cloud_storage">Cloud storage</option>
                <option value="local_storage">Local storage</option>
              </select>
            </div>
            <br>
            <div style="margin-top:8px;">
              <input type="hidden" name=event_id value="{{ event_id }}">
              <button type="submit" name="update_config" class="btn btn-success">Lagre</button>
              <button type="submit" name="reset_config" class="btn btn-warning">Nullstill</button>
            </div>
          </form>
        </div>
      </fieldset>
  </details>

  <script>
      // Initial call to start the cycle
      setTimeout(sync_status, 4000);

      // Get the modal
      document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('photo-modal');
        const modalImg = document.getElementById('modal-img');
        const trigger = document.getElementById('trigger_line_photo');
        const closeBtn = document.querySelector('.close-modal');

        trigger.onclick = function() {
          modal.style.display = "block";
          modalImg.src = this.src;
        }

        closeBtn.onclick = function() {
          modal.style.display = "none";
        }

        // Close when clicking outside image
        modal.onclick = function(e) {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        }

        // Close on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modal.style.display === 'block') {
            modal.style.display = "none";
          }
        });
      });
  </script>
  <div id="photo-modal" class="modal" aria-hidden="true" role="dialog">
    <div class="modal-content">
      <span class="close-modal" title="Lukk">&times;</span>
      <img id="modal-img" src="" alt="">
    </div>
  </div>
{% endblock %}
