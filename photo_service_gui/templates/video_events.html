{% extends "open_base_new.html" %}

{% block titleheader %}
  Deteksjon målpassering - {{ event.name }}
{% endblock %}

{% block headercontainer %}Deteksjon målpassering <img id=header_icon src="../static/icon_photos.png"> {% endblock %}

{% block titlemain %}
  <img id=menu_icon src="../static/icon_photos.png"> Deteksjon målpassering
{% endblock %}
{% block menuitems %}{% endblock %}

<! --- Information --->
{% block tips %}
  Dette er kontrollpanel for video service. Siden inneholder både mulighet til å konfigurere tjenesten samt overvåke. Video tjenesten analyserer en videostrøm og identifiserer personer som krysser en (mål)linje.
  Det lages to bilder av passeringen, ett av bare selve personen (crop) og ett av hele skjermen.
  <ul>
    <li><b>Målkamera</b>: Her vises status på tjenesten som lagrer video av målpassering. I tillegg kan man se bilde av registrert mål-linje. I køen vises antall råfiler og antall video filer ferdig prosessert.</li>
    <li><b>Passeringer</b>: Her vises status på tjenesten som detekterer passeringer. I tillegg kan man se bilde av sist registrerte passering. I køen vises antall filer som venter på deteksjon.</li>
    <li><b>Siste hendelser</b>: Her vises informasjon om de siste hendelsene som er registrert av systemet.</li>
    <li><b>Avansert</b>: Mulighet for å nullstille, dette krever normalt påfølgende restart av VIDEO SERVICE og INTEGRATION SERVICE.</li>
  </ul>
  <br>
  <b>Konfigurasjon</b>
  <br>
  Her kan alle parametere for video tjenesten settes. Dette inkluderer definisjon av mållinje, video url, videoklipp varighet, fps, confidence limit, bildeoppløsning for analyse og lagringsmodus.
  <ul>
    <li><b>local_storage</b>: local file system used for storage. Detections are pushed directly to cloud storage by the video service.</li>
    <li><b>cloud_storage</b>: capture run locally and integration service pushing captured files directly to cloud bucket, detection stored directly on cloud storage.</li>
  </ul>
{% endblock %}
<! --- End Information --->

{% block content %}
<script>
  /* this function will sync (update+get) status updates with backend */
  let syncRunning = false;
  function sync_status() {
    if (syncRunning) return; // Exit if already running
    syncRunning = true;

    try {
      var formData = "video_status=true&event_id={{ event_id }}"
      formData = formData + "&photo_queue=true"
      
      loadDoc("POST", "/video_events", mySync, formData);

      function mySync(xhttp) {
        try {
          // load new info
          const jsonDoc = JSON.parse(xhttp.response);
          document.getElementById("send_result").innerHTML = jsonDoc.video_status;
          document.getElementById("local_raw_captured_queue_length").innerHTML = jsonDoc.local_raw_captured_queue_length;
          document.getElementById("local_captured_queue_length").innerHTML = jsonDoc.local_captured_queue_length;
          document.getElementById("cloud_captured_queue_length").innerHTML = jsonDoc.cloud_captured_queue_length;
          const photo_latest = jsonDoc.photo_latest;
          if (photo_latest != "") {
            document.getElementById("photo_latest").src = photo_latest;
          }
          else {
            document.getElementById("photo_latest").src = "../static/no_image.png";
          }
          const trigger_line_url = jsonDoc.trigger_line_url;
          if (trigger_line_url != "") {
            document.getElementById("trigger_line_photo").src = trigger_line_url;
          }
          else {
            document.getElementById("trigger_line_photo").src = "../static/no_image.png";
          }

          // Update service status indicators - capture video service
          if (jsonDoc.service_status.capture_video_available) {
            if (jsonDoc.service_status.capture_video_start) {
              document.getElementById("capture_video_service_status").innerHTML = "Video: Kjører";
              document.getElementById("capture_video_service_status").className = "label label-success";
              document.getElementById("capture_video_service").innerHTML = "Stopp";
              document.getElementById("capture_video_service").value = "Stop";
              document.getElementById("capture_stop").innerHTML = "Stopp video";
              document.getElementById("capture_stop").value = "Stop capture";
              document.getElementById("capture_stop").style.display = "inline-block";
            } else {
                document.getElementById("capture_video_service_status").innerHTML = "Video: Pauset";
                document.getElementById("capture_video_service_status").className = "label label-warning";
                document.getElementById("capture_video_service").innerHTML = "Start";
                document.getElementById("capture_video_service").value = "Start";
                document.getElementById("capture_stop").innerHTML = "-";
                document.getElementById("capture_stop").value = "-";
                document.getElementById("capture_stop").style.display = "none";
            }
          } else {
            document.getElementById("capture_video_service_status").innerHTML = "Video: Ikke tilgjengelig";
            document.getElementById("capture_video_service_status").className = "label label-danger";
            document.getElementById("capture_video_service").innerHTML = "-";
            document.getElementById("capture_video_service").value = "-";
            document.getElementById("capture_stop").innerHTML = "-";
            document.getElementById("capture_stop").value = "-";
            document.getElementById("capture_stop").style.display = "none";
          }

          // Update service status indicators - integration service
          if (jsonDoc.service_status.integration_available) {
            if (jsonDoc.service_status.integration_start) {
              document.getElementById("integration_service_status").innerHTML = "Opplasting: Kjører";
              document.getElementById("integration_service_status").className = "label label-success";
              document.getElementById("capture_video_service").innerHTML = "Stopp";
              document.getElementById("capture_video_service").value = "Stop";
            } else {
              document.getElementById("integration_service_status").innerHTML = "Opplasting: Pauset";
              document.getElementById("integration_service_status").className = "label label-warning";
              document.getElementById("capture_video_service").innerHTML = "Start";
              document.getElementById("capture_video_service").value = "Start";
            }
          } else {
            document.getElementById("integration_service_status").innerHTML = "Opplasting: Ikke tilgjengelig";
            document.getElementById("integration_service_status").className = "label label-danger";
          }

          // Update service status indicators - detect video service
          if (jsonDoc.service_status.detect_video_available) {
            if (jsonDoc.service_status.detect_video_start) {
              document.getElementById("detect_video_service_status").innerHTML = "Deteksjon: Kjører";
              document.getElementById("detect_video_service_status").className = "label label-success";
              document.getElementById("detect_video_service").innerHTML = "Stopp";
              document.getElementById("detect_video_service").value = "Stop";
            } else {
              document.getElementById("detect_video_service_status").innerHTML = "Deteksjon: Pauset";
              document.getElementById("detect_video_service_status").className = "label label-warning";
              document.getElementById("detect_video_service").innerHTML = "Start";
              document.getElementById("detect_video_service").value = "Start";
            }
          } else {
            document.getElementById("detect_video_service_status").innerHTML = "Deteksjon: Ikke tilgjengelig";
            document.getElementById("detect_video_service_status").className = "label label-danger";
            document.getElementById("detect_video_service").innerHTML = "-";
            document.getElementById("detect_video_service").value = "-";
          }

        }
        catch(err) {
            alert(err);
        }
      }
    }
    catch(err) {
        alert(err);
    } finally {
      syncRunning = false; // Ensure flag is cleared even on errors
      setTimeout(sync_status, 4000);
    }
  }

  /* this function will get status updates */
  function loadDoc(req, url, cFunction, formData) {
    const xhttp = new XMLHttpRequest();
    xhttp.onload = function() {cFunction(this);}
    xhttp.open(req, url, true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.send(formData);
  }

</script>

    <section class="row" aria-label="Service status">
      <div class="col-sm-4">
        <div class="status-card" role="status" aria-live="polite">
          <h4>Målkamera</h4>
          <span id="capture_video_service_status" class="label label-danger">-</span>
          <span id="integration_service_status" class="label label-danger">-</span>
          <br>
          Kø: <strong id="local_raw_captured_queue_length">0</strong> (råfiler)
          {% if service_status.storage_mode_name == "cloud_storage" %} / <strong id="local_captured_queue_length">0</strong> (videoer){% endif %}
          <form action=/video_events method=post>
            <button type="submit" id="capture_video_service" name="capture_video_service" value="-" class="btn btn-default">-</button>
            <button type="submit" id="capture_stop" name="capture_stop" value="-" class="btn btn-default">-</button>
            <input type="hidden" name=event_id value="{{ event_id }}">
          </form>
        </div>
        <hr>
        <!-- preview inside the card -->
        <figure class="preview-figure">
          <img id="trigger_line_photo" class="preview-img" src="../static/no_image.png"
              alt="Crossing line, click to view big size" title="Click to enlarge">
        </figure>
      </div>
      <div class="col-sm-4">
        <div class="status-card" role="status" aria-live="polite">
          <h4>Passeringer</h4>
          <span id="detect_video_service_status" class="label label-danger">-</span>
          <br>
          {% if service_status.storage_mode_name == "cloud_storage" %}
            Kø: <strong id="cloud_captured_queue_length">0</strong>
          {% else %}
            Kø: <strong id="local_captured_queue_length">0</strong> (videoer)
            <input type="hidden" id="cloud_captured_queue_length" value="0">
          {% endif %}
          <form action=/video_events method=post>
            <button type="submit" id="detect_video_service" name="detect_video_service" value="-" class="btn btn-default">-</button>
            <input type="hidden" name=event_id value="{{ event_id }}">
          </form>
        </div>
        <hr>
        <!-- preview inside the card -->
        <figure class="preview-figure">
          <img id="photo_latest" class="preview-img" src="../static/no_image.png"
              alt="Latest detection">
        </figure>
      </div>

      <div class="col-sm-4">
        <div class="status-card" role="status" aria-live="polite">
          <h4>Siste hendelser (logg)</h4>
          <p id="send_result">—</p> 
        </div>
      </div>
    </section>
  <div id="spacer"></div>
  <hr>
  <details class="content-box">
    <summary>Konfigurasjon (klikk for å utvide)</summary>
    <fieldset>
      <legend>Video innstillinger</legend>

      <section class="row" aria-label="Previews and configuration">
        <div class="col-md-6 preview-col">
          <form action="/video_events" method="post" class="form-vertical" id="config-form" aria-label="Video configuration">
            <div class="form-group">
              <label for="trigger_line_xyxyn">Mållinjen</label> (x1:y1:x2:y2 , eks: 0.0:0.75:1.0:0.75)
              <input id="trigger_line_xyxyn" name="trigger_line_xyxyn" type="text" class="form-control" value="{{ trigger_line_xyxyn }}">
            </div>

            <div class="form-group">
              <label for="video_url">Video URL</label>
              <input id="video_url" name="video_url" type="url" class="form-control" value="{{ video_url }}">
            </div>

            <div class="form-group">
              <label for="video_clip_duration">Videoklipp varighet (s)</label>
              <input id="video_clip_duration" name="video_clip_duration" type="number" class="form-control" value="{{ service_status.video_clip_duration }}">
            </div>

            <div class="form-group">
              <label for="video_clip_fps">FPS</label> (antall bilder per sekund)
              <input id="video_clip_fps" name="video_clip_fps" type="number" class="form-control" value="{{ service_status.video_clip_fps }}">
            </div>
        </div>
        <div class="col-md-6 preview-col">
            <div class="form-group">
              <label for="confidence_limit">Confidence limit</label> (minimum confidence for detections)
              <input id="confidence_limit" name="confidence_limit" type="number" class="form-control" value="{{ service_status.confidence_limit }}">
            </div>

            <div class="form-group">
              <label for="detect_image_size">Image resolution</label>
              <select name="detect_image_size" class="form-control">
                <option value={{ service_status.detect_analytics_im_size }}>{{ service_status.detect_analytics_im_size }}</option>
                {% for one_res in service_status.video_analytics_im_size_def %}
                  <option value={{ one_res }}>{{ one_res }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label for="storage_mode">Video storage mode</label>
              <select id="storage_mode" name="storage_mode" class="form-control">
                <option value="0">{{ service_status.storage_mode_name }}</option>
                <option value="cloud_storage">Cloud storage</option>
                <option value="local_storage">Local storage</option>
              </select>
            </div>
            <br>
            <div style="margin-top:8px;">
              <input type="hidden" name=event_id value="{{ event_id }}">
              <button type="submit" name="update_config" class="btn btn-success">Lagre</button>
              <button type="submit" name="reset_config" class="btn btn-warning">Nullstill</button>
            </div>
          </form>
        </div>
      </fieldset>
  </details>

  <script>
      // Initial call to start the cycle
      setTimeout(sync_status, 4000);

      // Get the modal
      document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('photo-modal');
        const modalImg = document.getElementById('modal-img');
        const trigger = document.getElementById('trigger_line_photo');
        const closeBtn = document.querySelector('.close-modal');

        trigger.onclick = function() {
          modal.style.display = "block";
          modalImg.src = this.src;
        }

        closeBtn.onclick = function() {
          modal.style.display = "none";
        }

        // Close when clicking outside image
        modal.onclick = function(e) {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        }

        // Close on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modal.style.display === 'block') {
            modal.style.display = "none";
          }
        });
      });
  </script>
  <div id="photo-modal" class="modal" aria-hidden="true" role="dialog">
    <div class="modal-content">
      <span class="close-modal" title="Lukk">&times;</span>
      <img id="modal-img" src="" alt="">
    </div>
  </div>
{% endblock %}
