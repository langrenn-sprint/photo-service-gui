{% extends "open_base_new.html" %}

{% block titleheader %}
  Innstillinger
{% endblock %}

{% block headercontainer %}Innstillinger <img id=header_icon src="../static/icon_settings.png"> {% endblock %}

{% block titlemain %}
  <img id=menu_icon src="../static/icon_settings.png"> Innstillinger
{% endblock %}

{% block menuitems %}
  <li class=dropdown id=topborder>
    <a href=config?event_id={{ event_id }}&action=edit class=dropbtn>Rediger</a>
  </li>
{% endblock %}

{% block tips %}
  Her kan du se og redigere konfigurasjonsparametere for arrangementet.
{% endblock %}

{% block content %}
  <p>
    <span id="informasjon"></span>
  </p>
    <section class="row" aria-label="Live stream channels">
      <div class="col-sm-6">
        <h4>Live Stream Channels</h4>
      </div>
      <div class="col-sm-6">
        <h4>SRT Push Inputs</h4>
      </div>
    </section>
    <section class="row" aria-label="Live stream inputs">
      {% for channel in srt_streams.channels %}
      <div class="col-sm-6">
        <div class="status-card" role="status" aria-live="polite">
          <table>
            <tr>
              <td><strong>Status</strong></td>
              <td>
                <span class="label {% if channel.streaming_state == 6 %}label-success{% elif channel.streaming_state == 2 %}label-warning{% else %}label-default{% endif %}">
                  {{ channel.streaming_state.name }}
                </span>
              </td>
              <td><strong>Active Input</strong></td>
              <td>{{ channel.active_input }}</td>
            </tr>
            <tr>
              <td><strong>Channel Name</strong></td>
              <td colspan="3"><code style="font-size: 0.85em;">{{ channel.name }}</code></td>
            </tr>
            <tr>
              <td><strong>Output Location</strong></td>
              <td colspan="3"><code style="font-size: 0.85em;">{{ channel.output.uri if channel.output else 'N/A' }}</code></td>
            </tr>
          </table>
          
          <details style="margin-top: 10px;">
            <summary style="cursor: pointer; color: #0066cc;"><strong>Video Settings</strong></summary>
            <table style="margin-top: 10px;">
              {% for stream in channel.elementary_streams %}
                {% if stream.video_stream %}
                  <tr bgcolor="#f5f5f5">
                    <td><strong>Resolution</strong></td>
                    <td>{{ stream.video_stream.h264.width_pixels }}x{{ stream.video_stream.h264.height_pixels }}</td>
                    <td><strong>Frame Rate</strong></td>
                    <td>{{ stream.video_stream.h264.frame_rate }} fps</td>
                  </tr>
                  <tr bgcolor="#f5f5f5">
                    <td><strong>Bitrate</strong></td>
                    <td>{{ (stream.video_stream.h264.bitrate_bps / 1000000) | round(2) }} Mbps</td>
                    <td><strong>Profile</strong></td>
                    <td>{{ stream.video_stream.h264.profile }}</td>
                  </tr>
                {% endif %}
              {% endfor %}
            </table>
          </details>
          
          <details style="margin-top: 10px;">
            <summary style="cursor: pointer; color: #0066cc;"><strong>Audio Settings</strong></summary>
            <table style="margin-top: 10px;">
              {% for stream in channel.elementary_streams %}
                {% if stream.audio_stream %}
                  <tr bgcolor="#f5f5f5">
                    <td><strong>Codec</strong></td>
                    <td>{{ stream.audio_stream.codec | upper }}</td>
                    <td><strong>Bitrate</strong></td>
                    <td>{{ (stream.audio_stream.bitrate_bps / 1000) | round(0) | int }} kbps</td>
                  </tr>
                  <tr bgcolor="#f5f5f5">
                    <td><strong>Sample Rate</strong></td>
                    <td>{{ stream.audio_stream.sample_rate_hertz }} Hz</td>
                    <td><strong>Channels</strong></td>
                    <td>{{ stream.audio_stream.channel_count }}</td>
                  </tr>
                {% endif %}
              {% endfor %}
            </table>
          </details>
          
          <details style="margin-top: 10px;">
            <summary style="cursor: pointer; color: #0066cc;"><strong>Input Attachments</strong></summary>
            <table style="margin-top: 10px;">
              {% for attachment in channel.input_attachments %}
                <tr bgcolor="#f5f5f5">
                  <td><strong>{{ attachment.key }}</strong></td>
                  <td colspan="3"><code style="font-size: 0.85em;">{{ attachment.input }}</code></td>
                </tr>
              {% endfor %}
            </table>
          </details>
          
          <details style="margin-top: 10px;">
            <summary style="cursor: pointer; color: #0066cc;"><strong>Advanced Details</strong></summary>
            <table style="margin-top: 10px;">
              <tr bgcolor="#f5f5f5">
                <td><strong>Created</strong></td>
                <td>{{ channel.create_time }}</td>
                <td><strong>Updated</strong></td>
                <td>{{ channel.update_time }}</td>
              </tr>
              <tr bgcolor="#f5f5f5">
                <td><strong>Segment Duration</strong></td>
                <td>{{ channel.mux_streams[0].segment_settings.segment_duration.seconds if channel.mux_streams else 'N/A' }}s</td>
                <td><strong>Max Segments</strong></td>
                <td>{{ channel.manifests[0].max_segment_count if channel.manifests else 'N/A' }}</td>
              </tr>
              <tr bgcolor="#f5f5f5">
                <td><strong>Manifest</strong></td>
                <td>{{ channel.manifests[0].file_name if channel.manifests else 'N/A' }}</td>
                <td><strong>Type</strong></td>
                <td>{{ channel.manifests[0].type_ if channel.manifests else 'N/A' }}</td>
              </tr>
            </table>
          </details>
          {% if action == "edit" %}
            <form action=/config method=post>
              <input type="submit" class="btn btn-warning" name=delete_channel value="  Slett kanal og input ">
              <input type=hidden name="event_id" value="{{ event_id }}">
              <input type=hidden name="name" value="{{ channel.name }}">
              {% for attachment in channel.input_attachments %}
                <input type=hidden name="input" value="{{ attachment.input }}">
              {% endfor %}
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
    {% for input in srt_streams.inputs %}
      <div class="col-sm-6">
        <div class="status-card" role="status" aria-live="polite">
          <table>
            <tr>
              <td><strong>Type</strong></td>
              <td><span class="label label-success">{{ input.type_.name }}</span></td>
              <td><strong>Tier</strong></td>
              <td><span class="label label-default">{{ input.tier.name }}</span></td>
            </tr>
            <tr>
              <td><strong>Input name</strong></td>
              <td colspan="3"><code style="font-size: 0.85em;">{{ input.name }}</code></td>
            </tr>
            <tr>
              <td><strong>SRT Push URL</strong></td>
              <td colspan="3">
                <code style="font-size: 0.85em; word-break: break-all;">{{ input.uri }}</code>
                <button type="button" onclick="navigator.clipboard.writeText('{{ input.uri }}')" class="btn btn-default btn-sm" style="margin-left: 8px;">Kopier</button>
              </td>
            </tr>
          </table>
          
          <details style="margin-top: 10px;">
            <summary style="cursor: pointer; color: #0066cc;"><strong>Timestamps</strong></summary>
            <table style="margin-top: 10px;">
              <tr bgcolor="#f5f5f5">
                <td><strong>Created</strong></td>
                <td>{{ input.create_time }}</td>
                <td><strong>Updated</strong></td>
                <td>{{ input.update_time }}</td>
              </tr>
            </table>
          </details>
          {% if action == "edit" %}
            <form action=/config method=post>
              <input type="submit" class="btn btn-warning" name=delete_input value="  Slett  ">
              <input type=hidden name="event_id" value="{{ event_id }}">
              <input type=hidden name="name" value="{{ input.name }}">
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </section>
    {% if action == "edit" %}
    <br>
    <section class="row" aria-label="Event">
      <div class="col-sm-12">
        <form action=/config method=post>
          Navn: <input type="text" class="form-control" name=name value="" minlength="1" maxlength="63" pattern="[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?" title="Must be 1-63 characters, begin and end with a lower-case letter or number, and contain only lower-case letters, numbers, or hyphens.">
          <input type="submit" class="btn btn-success" name=create_channel value="  Opprett ny kanal og input ">
          <input type=hidden name="event_id" value="{{ event_id }}">
        </form>
      </div>
    </section>
    {% endif %}

  <hr>
  <section class="row" aria-label="Event">
    {% for service_instance in service_instances %}
      <div class="col-sm-12">
        <div class="status-card" role="status" aria-live="polite">
          <h4>
            Service Instance: {{ service_instance.instance_name }}
            <span class="label {% if service_instance.status == 'running' %}label-success{% elif service_instance.status == 'stopped' %}label-default{% else %}label-warning{% endif %}">{{ service_instance.status }}</span>
          </h4>
            {% set items = service_instance.items() | list %}
            {% for i in range(0, items | length, 2) %}
              <tr {% if loop.index % 2 == 0 %}bgcolor="#ddd"{% endif %}>
                <td><strong>{{ items[i][0] }}</strong></td>
                <td>{{ items[i][1] }}</td>
                {% if i + 1 < items | length %}
                  <td><strong>{{ items[i + 1][0] }}</strong></td>
                  <td>{{ items[i + 1][1] }}</td>
                {% else %}
                  <td></td>
                  <td></td>
                  {% endif %}
              </tr>
            {% endfor %}
          </table>
          {% if action == "edit" %}
            <form action=/config method=post>
              <input type="submit" class="btn btn-warning" name=delete_instance value="  Slett  ">
              <input type=hidden name="event_id" value="{{ event_id }}">
              <input type=hidden name="id" value="{{ service_instance.id }}">
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </section>
  <hr>
  <section class="row" aria-label="Event">
    <div class="col-sm-12">
      <div class="status-card" role="status" aria-live="polite">
        <h4>Config for event {{ event.name }}, {{ event.date_of_event }}</h4>
        <table>
          {% for oneconfig in event_config %}
            <tr {% if loop.index % 2 == 0 %}bgcolor="#ddd"{% endif %}>
              <td>&nbsp;{{ oneconfig.key }}&nbsp;</td>
              <td>
                {% if action == "edit" %}
                  <form action=/config method=post>
                    <input type="text" class="form-control" name="value" value="{{ oneconfig.value }}" required>
                    </td><td align="center">
                    <input type="submit" class="btn btn-success" name=update_one value="  Oppdater  ">
                    <input type=hidden name="event_id" value="{{ event_id }}">
                    <input type=hidden name="key" value="{{ oneconfig.key }}">
                  </form>
                {% else %}
                  {{ oneconfig.value }}
                  </td><td>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </table>
      </div>
    </div>
  </section>
{% endblock %}